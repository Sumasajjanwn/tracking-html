<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bus GPS Tracker</title>

<style>
body { font-family: Arial; padding: 20px; }
input, button { width: 100%; padding: 10px; margin: 5px 0; }
button { background: #2e86de; color: white; border: none; }
#status { margin-top: 15px; font-weight: bold; }
</style>

</head>
<body>

<h2>Bus GPS Tracker</h2>

<input type="text" id="busIdInput" placeholder="Enter Bus ID">
<button id="startBtn">Start Tracking</button>
<button id="stopBtn" style="background:red;">Stop Tracking</button>

<div id="status">Waiting...</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>

const SUPABASE_URL = "https://tiokiqoympxwfrjsefsy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpb2tpcW95bXB4d2ZyanNlZnN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMzU2NzAsImV4cCI6MjA3NDYxMTY3MH0.JiOA2nqekJcc3YtTlDZQY9J32I7BXJwzaJF3mJKKD6I";

const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const busIdInput = document.getElementById("busIdInput");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const statusDiv = document.getElementById("status");

let BUS_ID = null;
let watchId = null;
let lastPositions = [];
let totalDistance = 0;

function calculateDistance(pos1, pos2){
  const R = 6371e3;
  const toRad = x => x*Math.PI/180;

  const φ1 = toRad(pos1.lat);
  const φ2 = toRad(pos2.lat);
  const Δφ = toRad(pos2.lat-pos1.lat);
  const Δλ = toRad(pos2.lng-pos1.lng);

  const a = Math.sin(Δφ/2)**2 +
            Math.cos(φ1)*Math.cos(φ2)*
            Math.sin(Δλ/2)**2;

  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

function calculateSpeed(pos1,pos2){
  const dist = calculateDistance(pos1,pos2);
  const timeDiff = (new Date(pos2.time)-new Date(pos1.time))/1000;
  return timeDiff>0 ? (dist/timeDiff*3.6).toFixed(2) : 0;
}

startBtn.onclick = async () => {

  const busId = busIdInput.value.trim();
  if(!busId) return alert("Enter Bus ID");

  statusDiv.innerText="Checking Bus ID...";

  const { data, error } = await db
    .from("buses")
    .select("bus_id")
    .eq("bus_id", busId)
    .limit(1);

  if(error){
    statusDiv.innerText="Supabase Error: "+error.message;
    return;
  }

  if(!data || data.length===0){
    statusDiv.innerText="Bus ID not found!";
    return;
  }

  BUS_ID = busId;
  statusDiv.innerText="Tracking Started...";

  startTracking();
};

stopBtn.onclick = () => {
  if(watchId){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    statusDiv.innerText="Tracking Stopped.";
  }
};

function startTracking(){

  if(!navigator.geolocation){
    alert("Geolocation not supported");
    return;
  }

  watchId = navigator.geolocation.watchPosition(
    async (pos) => {

      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const updated_at = new Date().toISOString();

      lastPositions.push({lat,lng,time:updated_at});
      if(lastPositions.length>5) lastPositions.shift();

      const avgLat = lastPositions.reduce((s,p)=>s+p.lat,0)/lastPositions.length;
      const avgLng = lastPositions.reduce((s,p)=>s+p.lng,0)/lastPositions.length;

      let speed = 0;
      if(lastPositions.length>1){
        speed = calculateSpeed(
          lastPositions[lastPositions.length-2],
          lastPositions[lastPositions.length-1]
        );

        totalDistance += calculateDistance(
          lastPositions[lastPositions.length-2],
          lastPositions[lastPositions.length-1]
        )/1000;
      }

      statusDiv.innerText =
        "Lat: "+avgLat.toFixed(6)+
        " | Lng: "+avgLng.toFixed(6)+
        " | Speed: "+speed+" km/h"+
        " | Distance: "+totalDistance.toFixed(2)+" km";

      try{
        await db.from("bus_locations").insert([
          { bus_id: BUS_ID, latitude: avgLat, longitude: avgLng, updated_at }
        ]);

        await db.from("latest_positions").upsert(
          [{ bus_id: BUS_ID, latitude: avgLat, longitude: avgLng, updated_at }],
          { onConflict: "bus_id" }
        );

      }catch(err){
        console.error(err);
        statusDiv.innerText="Supabase Error: "+err.message;
      }

    },
    (err)=>{
      statusDiv.innerText="GPS Error: "+err.message;
    },
    {
      enableHighAccuracy: false,
      maximumAge: 1000,
      timeout: 10000
    }
  );
}

</script>
</body>
</html>
