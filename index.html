<script>
const SUPABASE_URL = "https://tiokiqoympxwfrjsefsy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpb2tpcW95bXB4d2ZyanNlZnN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMzU2NzAsImV4cCI6MjA3NDYxMTY3MH0.JiOA2nqekJcc3YtTlDZQY9J32I7BXJwzaJF3mJKKD6I";
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const busIdInput = document.getElementById("busIdInput");
const startBtn = document.getElementById("startBtn");
const statusDiv = document.getElementById("status");

let BUS_ID = null;
let watchId = null;
let lastPositions = [];
let totalDistance = 0;

function calculateDistance(p1,p2){
  const R = 6371e3;
  const toRad = x=>x*Math.PI/180;
  const φ1 = toRad(p1.lat);
  const φ2 = toRad(p2.lat);
  const Δφ = toRad(p2.lat-p1.lat);
  const Δλ = toRad(p2.lng-p1.lng);
  const a = Math.sin(Δφ/2)**2 +
            Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

function calculateSpeed(p1,p2){
  const dist = calculateDistance(p1,p2);
  const timeDiff = (new Date(p2.time)-new Date(p1.time))/1000;
  return timeDiff>0 ? Number((dist/timeDiff*3.6).toFixed(2)) : 0;
}

startBtn.onclick = async ()=>{

  if(watchId){
    alert("Already tracking!");
    return;
  }

  const busId = busIdInput.value.trim();
  if(!busId) return alert("Enter Bus ID");

  const { data,error } = await db
      .from("buses")
      .select("bus_id")
      .eq("bus_id",busId)
      .limit(1);

  if(error || !data || data.length===0){
    statusDiv.innerText="Bus ID not found!";
    return;
  }

  BUS_ID = busId;

  if(!navigator.geolocation){
    alert("Geolocation not supported");
    return;
  }

  watchId = navigator.geolocation.watchPosition(
    async pos => {

      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      if(pos.coords.accuracy > 60){
        statusDiv.innerText="Low GPS accuracy, waiting...";
        return;
      }

      const updated_at = new Date().toISOString();

      const current = {lat,lng,time:updated_at};

      lastPositions.push(current);
      if(lastPositions.length>5) lastPositions.shift();

      let speed = 0;

      if(lastPositions.length>1){
        const prev = lastPositions[lastPositions.length-2];
        const movement = calculateDistance(prev,current);

        if(movement < 15) return; // ignore tiny movement

        speed = calculateSpeed(prev,current);
        totalDistance += movement/1000;
      }

      statusDiv.innerText =
        `Lat: ${lat.toFixed(6)}
Lng: ${lng.toFixed(6)}
Speed: ${speed} km/h
Distance: ${totalDistance.toFixed(2)} km
Time: ${new Date().toLocaleTimeString("en-IN",{timeZone:"Asia/Kolkata"})}`;

      await db.from("bus_locations").insert([{
        bus_id:BUS_ID,
        latitude:lat,
        longitude:lng,
        updated_at
      }]);

      await db.from("latest_positions").upsert([{
        bus_id:BUS_ID,
        latitude:lat,
        longitude:lng,
        updated_at
      }],{onConflict:["bus_id"]});

    },
    err=>{
      if(err.code === 1){
        statusDiv.innerText="Location permission denied!";
      }else{
        statusDiv.innerText="GPS Error: "+err.message;
      }
    },
    {
      enableHighAccuracy:false,
      timeout:10000,
      maximumAge:0
    }
  );
};
</script>
