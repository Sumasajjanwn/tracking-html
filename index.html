<!DOCTYPE html>
<html>
<head>
  <title>Automatic Bus Tracking Test</title>
  <style>
    #map {
      height: 400px;
      width: 100%;
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid black;
      padding: 5px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h2>Automatic Bus Tracking Test</h2>
  <div id="map"></div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Time</th>
      </tr>
    </thead>
    <tbody id="locationTable"></tbody>
  </table>

  <!-- Google Maps API -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDKY1AZz2IX1CWtAD6-aun7ViJQb8OEvTo&callback=initMap"
    async defer
  ></script>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
    // ✅ Supabase setup
    const SUPABASE_URL = "https://tiokiqoympxwfrjsefsy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRpb2tpcW95bXB4d2ZyanNlZnN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMzU2NzAsImV4cCI6MjA3NDYxMTY3MH0.JiOA2nqekJcc3YtTlDZQY9J32I7BXJwzaJF3mJKKD6I";
    const BUS_ID = "7f1f1e10-0001-0000-0000-000000000001";

    // ✅ Correct Supabase initialization (fixes earlier bug)
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let map;
    let busMarker;
    let count = 0;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: { lat: 17.3850, lng: 78.4867 } // Default starting point
      });

      busMarker = new google.maps.Marker({
        map: map,
        title: "Bus Location"
      });

      startAutoSendLocation(); // Start GPS tracking loop
    }

    function startAutoSendLocation() {
      if (!navigator.geolocation) {
        alert("Geolocation not supported by your browser.");
        return;
      }

      setInterval(() => {
        navigator.geolocation.getCurrentPosition(async (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const time = new Date().toLocaleTimeString();

          // Update table
          count++;
          const row = document.createElement("tr");
          row.innerHTML = `<td>${count}</td><td>${lat.toFixed(6)}</td><td>${lng.toFixed(6)}</td><td>${time}</td>`;
          document.getElementById("locationTable").appendChild(row);

          // Update map marker
          const pos = new google.maps.LatLng(lat, lng);
          busMarker.setPosition(pos);
          map.setCenter(pos);

          // ✅ Store data to Supabase
          try {
            // Insert new record into bus_locations
            const { error: insertError } = await db
              .from('bus_locations')
              .insert([{ bus_id: BUS_ID, latitude: lat, longitude: lng }]);
            if (insertError) throw insertError;

            // Upsert (update or insert) into latest_positions
            const { error: upsertError } = await db
              .from('latest_positions')
              .upsert([
                {
                  bus_id: BUS_ID,
                  latitude: lat,
                  longitude: lng,
                  updated_at: new Date().toISOString()
                }
              ]);
            if (upsertError) throw upsertError;

            console.log(`✅ Stored location: ${lat}, ${lng} at ${time}`);
          } catch (err) {
            console.error("❌ Error sending to Supabase:", err.message);
          }
        }, (err) => {
          console.error("❌ Error getting GPS:", err);
        });
      }, 5000); // every 5 seconds
    }
  </script>
</body>
</html>
